<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0f1115;color:#eaeaea}

header{
padding:10px 16px;
display:flex;
justify-content:space-between;
align-items:center
}

header button{
background:#1f2228;
color:#fff;
border:none;
padding:6px 10px;
cursor:pointer
}

.weekdays{
display:grid;
grid-template-columns:repeat(7,1fr);
background:#14161b;
border-bottom:1px solid #24262b
}

.weekdays div{
text-align:center;
padding:6px 0;
font-size:12px;
opacity:.7
}

.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
height:calc(100vh - 210px)
}

.day{
border:1px solid #24262b;
padding:6px;
font-size:12px
}

.day-number{
opacity:.6;
margin-bottom:4px
}

/* TASK */
.task{
position:relative;
padding:6px;
border-radius:6px;
margin-bottom:4px;
cursor:grab;
color:#000
}

.task.readonly{
cursor:default;
opacity:.85
}

.task.done{
opacity:.45;
filter:grayscale(.2)
}

.task.done strong{
text-decoration:line-through
}

.task.done::after{
content:"Completed";
position:absolute;
top:2px;
right:6px;
font-size:9px;
background:#1b5e20;
color:#fff;
padding:2px 6px;
border-radius:10px
}

.task-type{
font-size:10px;
opacity:.8
}

/* ICONS */
.delete,.copy-btn,.edit-btn{
position:absolute;
bottom:2px;
font-size:14px;
cursor:pointer;
opacity:0
}

.delete{right:6px}
.edit-btn{right:24px}
.copy-btn{right:42px}

.task:hover .delete,
.task:hover .copy-btn,
.task:hover .edit-btn{
opacity:1
}

.add{
opacity:.5;
cursor:pointer;
font-size:11px
}
.add:hover{opacity:1}

/* MODAL */
.modal{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:none;
align-items:center;
justify-content:center
}

.modal-box{
background:#1b1d22;
padding:16px;
border-radius:10px;
width:260px
}

.modal-box input,
.modal-box select{
width:100%;
margin-bottom:8px;
padding:6px;
background:#1f2228;
color:#fff;
border:1px solid #333
}

.filter-bar{
display:flex;
gap:8px;
padding:8px 16px
}

.filter-bar select{
background:#1f2228;
color:#fff;
border:none;
padding:6px
}

/* TOAST */
.toast{
position:fixed;
bottom:50px;
left:50%;
transform:translateX(-50%);
background:#333;
padding:8px 14px;
border-radius:6px;
opacity:0;
transition:.25s
}
.toast.show{opacity:1}

/* EDIT BAR */
.edit-bar{
position:fixed;
bottom:10px;
left:50%;
transform:translateX(-50%);
display:flex;
gap:6px
}

.edit-bar input{
background:#1f2228;
border:1px solid #333;
color:#fff;
padding:6px
}

.edit-bar button{
background:#2e7d32;
border:none;
color:#fff;
padding:6px 10px;
cursor:pointer
}
</style>
</head>

<body>

<header>
<button onclick="changeMonth(-1)">‚Üê</button>
<div id="title"></div>
<button onclick="changeMonth(1)">‚Üí</button>
</header>

<div class="filter-bar">
<select id="filterPerson">
<option value="">All people</option>
</select>

<select id="viewMode">
<option value="normal">Normal</option>
<option value="assign">Assign Order</option>
</select>
</div>

<div class="weekdays">
<div>Mon</div><div>Tue</div><div>Wed</div>
<div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div id="calendar" class="calendar"></div>

<!-- MODAL -->
<div class="modal" id="modal" onclick="closeModal(event)">
<div class="modal-box">
<input id="taskText" placeholder="Task">
<select id="taskPerson"></select>
<select id="taskType"></select>
<select id="taskAM"></select>
<button onclick="saveTask()">Save</button>
</div>
</div>

<div class="toast" id="toast"></div>

<div class="edit-bar">
<input id="editCode" placeholder="Edit code">
<button onclick="unlockEdit()">Unlock</button>
</div>

<script>

/* ========= CONFIG ========= */

const EDIT_CODE="TEAM2026";

const TELEGRAM_WEBHOOK="YOUR_WEBHOOK";

const supabaseClient=supabase.createClient(
"https://letbykkygmmdxbmnemam.supabase.co",
"sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);

/* ========= DATA ========= */

const PEOPLE={
Tony:"#ff8a80",
Allen:"#90caf9",
Davis:"#b39ddb",
Alex:"#ffe082"
};

const TYPES=["Design","Menu","QR"];
const AM_LIST=["None","Luna","Nancy"];

let current=new Date();
let cache={};
let selectedDay=null;
let editingTask=null;
let canEdit=localStorage.getItem("canEdit")==="1";

/* ========= HELPERS ========= */

function toast(msg){
toastEl.textContent=msg;
toastEl.classList.add("show");
setTimeout(()=>toastEl.classList.remove("show"),1200);
}

function formatDate(y,m,d){
return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ========= TELE ========= */

async function sendTelegram(data){
fetch(TELEGRAM_WEBHOOK,{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify(data)
});
}

/* ========= LOAD ========= */

async function load(){

const y=current.getFullYear();
const m=current.getMonth();

const start=formatDate(y,m,1);
const end=formatDate(y,m,31);

const {data}=await supabaseClient
.from("tasks")
.select("*")
.gte("task_date",start)
.lte("task_date",end)
.order("sort_order");

cache={};

(data||[]).forEach(t=>{
const d=+t.task_date.slice(8,10);
(cache[d]??=[]).push(t);
});
}

/* ========= RENDER ========= */

async function render(){
await load();

calendar.innerHTML="";
title.textContent=`${current.getMonth()+1}/${current.getFullYear()}`;

const days=new Date(
current.getFullYear(),
current.getMonth()+1,
0
).getDate();

for(let d=1;d<=days;d++){

const day=document.createElement("div");
day.className="day";
day.innerHTML=`<div class="day-number">${d}</div>`;

(cache[d]||[]).forEach(t=>{

const el=document.createElement("div");
el.className="task"+(t.done?" done":"");
el.style.background=PEOPLE[t.person];

el.innerHTML=
`<strong>${t.text}</strong>
<div class="task-type">
${t.person} ‚Ä¢ ${t.type} ‚Ä¢ ${t.am}
</div>`;

/* COPY */
const copy=document.createElement("span");
copy.className="copy-btn";
copy.textContent="üìã";
copy.onclick=e=>{
e.stopPropagation();
navigator.clipboard.writeText(t.text);
};
el.appendChild(copy);

/* EDIT */
if(canEdit){
const edit=document.createElement("span");
edit.className="edit-btn";
edit.textContent="‚úèÔ∏è";
edit.onclick=e=>{
e.stopPropagation();
openEdit(t,d);
};
el.appendChild(edit);
}

/* DELETE */
if(canEdit){
const del=document.createElement("span");
del.className="delete";
del.textContent="‚úñ";
del.onclick=e=>{
e.stopPropagation();
removeTask(t.id);
};
el.appendChild(del);
}

day.appendChild(el);

});

/* ADD */
if(canEdit){
const add=document.createElement("div");
add.className="add";
add.textContent="+ Add";
add.onclick=()=>openModal(d);
day.appendChild(add);
}

calendar.appendChild(day);
}
}

/* ========= EDIT ========= */

function openEdit(t,d){
editingTask=t;
selectedDay=d;

taskText.value=t.text;
taskPerson.value=t.person;
taskType.value=t.type;
taskAM.value=t.am;

modal.style.display="flex";
}

/* ========= SAVE ========= */

async function saveTask(){

if(editingTask){

await supabaseClient
.from("tasks")
.update({
text:taskText.value,
person:taskPerson.value,
type:taskType.value,
am:taskAM.value
})
.eq("id",editingTask.id);

sendTelegram({
event:"edit",
message:taskText.value
});

editingTask=null;
closeModal();
render();
return;
}

const task={
task_date:formatDate(
current.getFullYear(),
current.getMonth(),
selectedDay),
text:taskText.value,
person:taskPerson.value,
type:taskType.value,
am:taskAM.value,
done:false,
sort_order:0
};

await supabaseClient.from("tasks").insert(task);

sendTelegram({
event:"new",
message:task.text
});

closeModal();
render();
}

/* ========= DELETE ========= */

async function removeTask(id){

await supabaseClient
.from("tasks")
.delete()
.eq("id",id);

sendTelegram({
event:"delete"
});

render();
}

/* ========= UI ========= */

function openModal(d){
selectedDay=d;
modal.style.display="flex";
}

function closeModal(e){
if(!e||e.target===modal){
modal.style.display="none";
editingTask=null;
}
}

function changeMonth(n){
current.setMonth(current.getMonth()+n);
render();
}

function unlockEdit(){
if(editCode.value===EDIT_CODE){
canEdit=true;
localStorage.setItem("canEdit","1");
render();
}
}

/* INIT */

Object.keys(PEOPLE).forEach(p=>{
taskPerson.innerHTML+=`<option>${p}</option>`;
filterPerson.innerHTML+=`<option>${p}</option>`;
});

TYPES.forEach(t=>{
taskType.innerHTML+=`<option>${t}</option>`;
});

AM_LIST.forEach(a=>{
taskAM.innerHTML+=`<option>${a}</option>`;
});

render();

</script>
</body>
</html>
