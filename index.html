<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Team Task Calendar</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0f1115;color:#fff}
header{display:flex;justify-content:space-between;padding:10px}
.weekdays,.calendar{display:grid;grid-template-columns:repeat(7,1fr)}
.weekdays div{text-align:center;opacity:.6}
.day{border:1px solid #222;padding:6px;font-size:12px}
.day-number{opacity:.5;margin-bottom:4px}
.task{padding:6px;border-radius:6px;margin-bottom:4px;color:#000;cursor:pointer;position:relative}
.task.done{background:#c8e6c9!important}
.task small{display:block;font-size:10px}
.delete{position:absolute;top:2px;right:4px;cursor:pointer}
.add{opacity:.5;font-size:11px;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-box{background:#1b1d22;padding:16px;border-radius:10px;width:260px}
.modal-box input,.modal-box select{width:100%;margin-bottom:8px}
button{cursor:pointer}
</style>
</head>

<body>

<button id="loginBtn">Login Google</button>

<div id="app" style="display:none">
<header>
<button onclick="changeMonth(-1)">←</button>
<div id="title"></div>
<button onclick="changeMonth(1)">→</button>
</header>

<div class="weekdays">
<div>Mon</div><div>Tue</div><div>Wed</div>
<div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div class="calendar" id="calendar"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <input id="taskTitle" placeholder="Task name">
    <select id="taskPerson"></select>
    <select id="taskType"></select>
    <button onclick="saveTask()">Add task</button>
  </div>
</div>

<script>
/* ================= SUPABASE CONFIG ================= */
const supabaseUrl = "https://YOUR_PROJECT_ID.supabase.co";
const supabaseKey = "YOUR_PUBLIC_ANON_KEY";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

/* ================= CONFIG ================= */
const PEOPLE = {
  Tony:"#ff8a80", Allen:"#90caf9", Davis:"#b39ddb", Alex:"#ffe082",
  Lucas:"#b0bec5", Hayden:"#f48fb1", Leo:"#ce93d8", Dante:"#a5d6a7"
};
const TYPES = ["Design + QR","Design","Menu + QR","Menu","QR"];

/* ================= STATE ================= */
let current = new Date();
let selectedDay = null;

/* ================= INIT ================= */
Object.keys(PEOPLE).forEach(p=>{
  taskPerson.innerHTML += `<option value="${p}">${p}</option>`;
});
TYPES.forEach(t=>{
  taskType.innerHTML += `<option>${t}</option>`;
});

/* ================= AUTH ================= */
loginBtn.onclick = async () => {
  await supabase.auth.signInWithOAuth({ provider: "google" });
};

supabase.auth.onAuthStateChange((_e, session)=>{
  if(session){
    loginBtn.style.display="none";
    app.style.display="block";
    loadTasks();
  }
});

/* ================= LOAD TASKS ================= */
async function loadTasks(){
  const monthKey = `${current.getFullYear()}-${current.getMonth()+1}`;
  const { data } = await supabase
    .from("tasks")
    .select("*")
    .eq("month", monthKey);

  render(data||[]);
}

/* ================= REALTIME ================= */
supabase
.channel("tasks")
.on("postgres_changes",{event:"*",schema:"public",table:"tasks"}, loadTasks)
.subscribe();

/* ================= RENDER ================= */
function render(tasks){
  calendar.innerHTML="";
  title.textContent=`Tháng ${current.getMonth()+1}/${current.getFullYear()}`;

  const days = new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
  const offset=(new Date(current.getFullYear(),current.getMonth(),1).getDay()+6)%7;

  for(let i=0;i<offset;i++) calendar.appendChild(document.createElement("div"));

  for(let d=1;d<=days;d++){
    const cell=document.createElement("div");
    cell.className="day";
    cell.innerHTML=`<div class="day-number">${d}</div>`;

    tasks.filter(t=>t.day===d).forEach(t=>{
      const el=document.createElement("div");
      el.className="task"+(t.done?" done":"");
      el.style.background=PEOPLE[t.person];
      el.innerHTML=`
        <span class="delete" onclick="deleteTask('${t.id}')">✖</span>
        ${t.title}
        <small>${t.person} • ${t.task_type}</small>
      `;
      el.onclick=()=>toggleDone(t.id,!t.done);
      cell.appendChild(el);
    });

    const add=document.createElement("div");
    add.className="add";
    add.textContent="+ Add task";
    add.onclick=()=>openModal(d);
    cell.appendChild(add);

    calendar.appendChild(cell);
  }
}

/* ================= CRUD ================= */
function openModal(day){
  selectedDay=day;
  modal.style.display="flex";
}

modal.onclick=e=>{
  if(e.target===modal) modal.style.display="none";
};

async function saveTask(){
  await supabase.from("tasks").insert({
    title:taskTitle.value,
    day:selectedDay,
    month:`${current.getFullYear()}-${current.getMonth()+1}`,
    person:taskPerson.value,
    task_type:taskType.value
  });
  modal.style.display="none";
}

async function toggleDone(id,val){
  await supabase.from("tasks").update({done:val}).eq("id",id);
}

async function deleteTask(id){
  if(confirm("Delete task?"))
    await supabase.from("tasks").delete().eq("id",id);
}

function changeMonth(step){
  current.setMonth(current.getMonth()+step);
  loadTasks();
}
</script>

</body>
</html>
