<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ==== STYLE GI·ªÆ NGUY√äN ==== */
body{margin:0;font-family:system-ui;background:#0f1115;color:#eaeaea}
header{padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
header button{background:#1f2228;color:#fff;border:none;padding:6px 10px;cursor:pointer}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#14161b;border-bottom:1px solid #24262b}
.weekdays div{text-align:center;padding:6px 0;font-size:12px;opacity:.7}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);height:calc(100vh - 210px)}
.day{border:1px solid #24262b;padding:6px;font-size:12px}
.day-number{opacity:.6;margin-bottom:4px}
.task{position:relative;padding:6px;border-radius:6px;margin-bottom:4px;cursor:grab;color:#000}
.task.readonly{cursor:default;opacity:.85}
.task.done{opacity:.45;filter:grayscale(.15)}
.task.done::after{
  content:"Completed";position:absolute;top:2px;right:6px;font-size:9px;
  background:#1b5e20;color:#fff;padding:2px 6px;border-radius:10px
}
.task-type{font-size:10px;opacity:.8}
.delete,.copy-btn{position:absolute;bottom:2px;font-size:14px;cursor:pointer;opacity:0}
.delete{right:6px}.copy-btn{right:22px}
.task:hover .delete,.task:hover .copy-btn{opacity:1}
.add{opacity:.5;cursor:pointer;font-size:11px}
.add:hover{opacity:1}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-box{background:#1b1d22;padding:16px;border-radius:10px;width:260px}
.modal-box input,.modal-box select{
  width:100%;margin-bottom:8px;padding:6px;background:#1f2228;color:#fff;border:1px solid #333
}
.toast{
  position:fixed;bottom:50px;left:50%;transform:translateX(-50%);
  background:#333;color:#fff;padding:8px 14px;border-radius:6px;
  font-size:12px;opacity:0;transition:.25s
}
.toast.show{opacity:1}
</style>
</head>

<body>

<header>
  <button onclick="changeMonth(-1)">‚Üê</button>
  <div id="title"></div>
  <button onclick="changeMonth(1)">‚Üí</button>
</header>

<div class="calendar" id="calendar"></div>

<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-box">
    <input id="taskText" placeholder="Task name">
    <select id="taskPerson"></select>
    <select id="taskType"></select>
    <button onclick="saveTask()">Add Task</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== CONFIG ===== */
const TELEGRAM_WEBHOOK =
  "https://script.google.com/macros/s/AKfycbwwSieGxwThxZu7RllRbFzI6RHFkHEnmQuh3gzafj4KyvNKEchUl7QwdxRW1_4b3o5CHA/exec";

const PEOPLE={
  Tony:"#ff8a80",Allen:"#90caf9",Davis:"#b39ddb",Alex:"#ffe082",
  Lucas:"#b0bec5",Hayden:"#f48fb1",Leo:"#ce93d8",Dante:"#a5d6a7"
};
const TYPES=["Design + QR","Design","Menu + QR","Menu","QR"];

let current=new Date();
let selectedDay=null;
let cache={};

/* ===== TELEGRAM ===== */
function notifyTelegram(msg){
  fetch(TELEGRAM_WEBHOOK,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ message: msg })
  }).catch(()=>{});
}

/* ===== HELPERS ===== */
function toast(msg,color="#333"){
  const t=document.getElementById("toast");
  t.textContent=msg;t.style.background=color;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}
function formatDate(y,m,d){
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ===== RENDER ===== */
function renderCalendar(){
  calendar.innerHTML="";
  title.textContent=`Th√°ng ${current.getMonth()+1}/${current.getFullYear()}`;
  const days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
  const offset=(new Date(current.getFullYear(),current.getMonth(),1).getDay()+6)%7;
  for(let i=0;i<offset;i++)calendar.appendChild(document.createElement("div"));

  for(let d=1;d<=days;d++){
    const day=document.createElement("div");
    day.className="day";
    day.innerHTML=`<div class="day-number">${d}</div>`;

    (cache[d]||[]).forEach(t=>{
      const el=document.createElement("div");
      el.className="task"+(t.done?" done":"");
      el.style.background=PEOPLE[t.person];
      el.onclick=()=>{
        t.done=!t.done;
        notifyTelegram(`‚úÖ <b>${t.text}</b>\nüë§ ${t.person}\nüìÖ ${t.task_date}`);
        renderCalendar();
      };
      el.innerHTML=`<strong>${t.text}</strong>
        <div class="task-type">${t.person} ‚Ä¢ ${t.type}</div>`;
      day.appendChild(el);
    });

    const add=document.createElement("div");
    add.className="add";
    add.textContent="+ Add task";
    add.onclick=()=>openModal(d);
    day.appendChild(add);

    calendar.appendChild(day);
  }
}

/* ===== ACTIONS ===== */
function openModal(d){selectedDay=d;modal.style.display="flex";}
function closeModal(e){if(!e||e.target===modal)modal.style.display="none";}

function saveTask(){
  const task={
    task_date:formatDate(current.getFullYear(),current.getMonth(),selectedDay),
    text:taskText.value,
    person:taskPerson.value,
    type:taskType.value,
    done:false
  };
  (cache[selectedDay]??=[]).push(task);
  notifyTelegram(`üÜï <b>New Task</b>\nüìå ${task.text}\nüë§ ${task.person}\nüìÖ ${task.task_date}`);
  renderCalendar();closeModal();
}

function changeMonth(n){current.setMonth(current.getMonth()+n);renderCalendar();}

/* ===== INIT ===== */
Object.keys(PEOPLE).forEach(p=>taskPerson.innerHTML+=`<option>${p}</option>`);
TYPES.forEach(t=>taskType.innerHTML+=`<option>${t}</option>`);
renderCalendar();
</script>
</body>
</html>
