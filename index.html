<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Team Task Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f5f6f8;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #fff;
      border-bottom: 1px solid #ddd;
    }
    button { cursor: pointer; }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      padding: 16px;
    }
    .day {
      background: #fff;
      border-radius: 8px;
      padding: 6px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
    }
    .day-header {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .date {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .task {
      background: #e9eefc;
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 12px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .task.done {
      background: #d6f5e3;
      text-decoration: line-through;
    }
    .task span.remove {
      color: red;
      cursor: pointer;
      font-weight: bold;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    select, input { padding: 6px; }
  </style>
</head>

<body>

<header>
  <button id="prevMonth">←</button>
  <h3 id="monthLabel"></h3>
  <button id="nextMonth">→</button>
</header>

<div class="calendar" id="calendar"></div>

<button id="openModal" style="margin:16px;">+ Add Task</button>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Add Task</h3>
    <input id="taskText" placeholder="Task..." />
    <input id="taskDate" type="date" />
    <select id="taskPerson">
      <option>Tony</option><option>Allen</option><option>Davis</option>
      <option>Alex</option><option>Lucas</option>
      <option>Hayden</option><option>Leo</option><option>Dante</option>
    </select>
    <select id="taskType">
      <option>Design + QR</option><option>Design</option>
      <option>Menu + QR</option><option>Menu</option><option>QR</option>
    </select>
    <button id="saveTask">Save</button>
    <button id="closeModal">Cancel</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/* ===== SUPABASE ===== */
const supabase = createClient(
  "https://letbykkygmmdxbmnemam.supabase.co",
  "sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);

/* ===== STATE ===== */
let current = new Date();
let tasks = [];

/* ===== DOM ===== */
const calendar = document.getElementById("calendar");
const monthLabel = document.getElementById("monthLabel");
const modal = document.getElementById("modal");

/* ===== HELPERS ===== */
const ymd = d => d.toISOString().slice(0, 10);

/* ===== LOAD ===== */
async function loadTasks() {
  const start = new Date(current.getFullYear(), current.getMonth(), 1);
  const end = new Date(current.getFullYear(), current.getMonth() + 1, 0);

  const { data, error } = await supabase
    .from("tasks")
    .select("*")
    .gte("task_date", ymd(start))
    .lte("task_date", ymd(end))
    .order("task_date");

  if (!error) tasks = data || [];
}

/* ===== RENDER ===== */
async function render() {
  await loadTasks();

  calendar.innerHTML = "";
  monthLabel.textContent =
    current.toLocaleString("vi", { month: "long", year: "numeric" });

  const days = new Date(
    current.getFullYear(),
    current.getMonth() + 1,
    0
  ).getDate();

  for (let d = 1; d <= days; d++) {
    const date = new Date(current.getFullYear(), current.getMonth(), d);
    const key = ymd(date);

    const box = document.createElement("div");
    box.className = "day";
    box.innerHTML = `
      <div class="day-header">${date.toLocaleDateString("vi", { weekday: "short" })}</div>
      <div class="date">${d}</div>
    `;

    tasks.filter(t => t.task_date === key).forEach(t => {
      const el = document.createElement("div");
      el.className = "task" + (t.done ? " done" : "");
      el.innerHTML = `<span>${t.text}</span><span class="remove">×</span>`;

      el.querySelector(".remove").onclick = e => {
        e.stopPropagation();
        supabase.from("tasks").delete().eq("id", t.id);
      };

      el.ondblclick = () =>
        supabase.from("tasks").update({ done: !t.done }).eq("id", t.id);

      box.appendChild(el);
    });

    calendar.appendChild(box);
  }
}

/* ===== EVENTS ===== */
document.getElementById("prevMonth").onclick = () => {
  current.setMonth(current.getMonth() - 1);
  render();
};

document.getElementById("nextMonth").onclick = () => {
  current.setMonth(current.getMonth() + 1);
  render();
};

document.getElementById("openModal").onclick = () => {
  modal.classList.add("active");
  taskDate.value = ymd(new Date());
};

document.getElementById("closeModal").onclick = () =>
  modal.classList.remove("active");

document.getElementById("saveTask").onclick = async () => {
  if (!taskText.
