<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
    margin: 0;
    font-family: system-ui, Arial;
    background: #0f1115;
    color: #eaeaea;
}

/* ===== HEADER ===== */
header {
    padding: 10px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
header button {
    background: #1f2228;
    color: #fff;
    border: none;
    padding: 6px 10px;
    cursor: pointer;
}

/* ===== WEEKDAYS ===== */
.weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #14161b;
    border-bottom: 1px solid #24262b;
}
.weekdays div {
    text-align: center;
    padding: 6px 0;
    font-size: 12px;
    opacity: 0.7;
}

/* ===== CALENDAR ===== */
.calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    height: calc(100vh - 120px);
}
.day {
    border: 1px solid #24262b;
    padding: 6px;
    font-size: 12px;
}
.day-number {
    opacity: 0.6;
    margin-bottom: 4px;
}

/* ===== TASK ===== */
.task {
    position: relative;
    padding: 6px;
    border-radius: 6px;
    margin-bottom: 4px;
    cursor: grab;
    color: #000;
}
.task.done {
    background: #c8e6c9 !important;
}
.task-type {
    font-size: 10px;
    opacity: .8;
}
.delete {
    position: absolute;
    top: 2px;
    right: 4px;
    font-size: 12px;
    cursor: pointer;
    opacity: 0;
}
.task:hover .delete {
    opacity: 1;
}

/* ===== ADD ===== */
.add {
    opacity: .5;
    cursor: pointer;
    font-size: 11px;
}
.add:hover { opacity: 1; }

/* ===== MODAL ===== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    align-items: center;
    justify-content: center;
}
.modal-box {
    background: #1b1d22;
    padding: 16px;
    border-radius: 10px;
    width: 260px;
}
.modal-box input,
.modal-box select {
    width: 100%;
    margin-bottom: 8px;
    padding: 6px;
}
.modal-box button {
    width: 100%;
}
</style>
</head>

<body>

<header>
    <button id="prev">←</button>
    <div id="title"></div>
    <button id="next">→</button>
</header>

<div class="weekdays">
    <div>Mon</div><div>Tue</div><div>Wed</div>
    <div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div class="calendar" id="calendar"></div>

<!-- MODAL -->
<div class="modal" id="modal">
    <div class="modal-box">
        <input id="taskText" placeholder="Task name">
        <select id="taskPerson"></select>
        <select id="taskType"></select>
        <button id="addTaskBtn">Add Task</button>
    </div>
</div>

<script>
/* ================= CONFIG ================= */
const PEOPLE = {
    Tony:"#ff8a80", Allen:"#90caf9", Davis:"#b39ddb", Alex:"#ffe082",
    Lucas:"#b0bec5", Hayden:"#f48fb1", Leo:"#ce93d8", Dante:"#a5d6a7"
};
const TYPES = ["Design + QR","Design","Menu + QR","Menu","QR"];

/* ================= SUPABASE ================= */
const supabaseClient = window.supabase.createClient(
  "https://letbykkygmmdxbmnemam.supabase.co",
  "sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);

/* ================= STATE ================= */
let current = new Date();
let selectedDay = null;
let dragTask = null;

const calendar = document.getElementById("calendar");
const modal = document.getElementById("modal");

/* ================= UTILS ================= */
function formatDateLocal(y,m,d){
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ================= RENDER ================= */
async function render(){
  calendar.innerHTML = "";
  document.getElementById("title").textContent =
    current.toLocaleString("vi",{month:"long",year:"numeric"});

  const start = formatDateLocal(current.getFullYear(),current.getMonth(),1);
  const end   = formatDateLocal(current.getFullYear(),current.getMonth()+1,0);

  const {data:tasks} = await supabaseClient
    .from("tasks")
    .select("*")
    .gte("task_date",start)
    .lte("task_date",end);

  const map = {};
  (tasks||[]).forEach(t=>{
    if(!map[t.task_date]) map[t.task_date]=[];
    map[t.task_date].push(t);
  });

  for(let d=1; d<=new Date(current.getFullYear(),current.getMonth()+1,0).getDate(); d++){
    const day = document.createElement("div");
    day.className="day";
    day.dataset.day=d;

    day.innerHTML = `<div class="day-number">${d}</div>
      <div class="add">+ Add</div>`;

    day.querySelector(".add").onclick=()=>{
      selectedDay=d;
      modal.style.display="flex";
    };

    day.ondragover=e=>e.preventDefault();
    day.ondrop=()=>dropTask(d);

    (map[formatDateLocal(current.getFullYear(),current.getMonth(),d)]||[])
    .forEach(t=>{
      const div=document.createElement("div");
      div.className="task"+(t.done?" done":"");
      div.draggable=true;
      div.style.background=PEOPLE[t.person]||"#ccc";
      div.innerHTML=`
        <div>${t.text}</div>
        <div class="task-type">${t.type}</div>
        <div class="delete">✕</div>
      `;

      div.ondragstart=()=>dragTask=t;
      div.onclick=()=>toggleDone(t);
      div.querySelector(".delete").onclick=e=>{
        e.stopPropagation();
        removeTask(t.id);
      };
      day.appendChild(div);
    });

    calendar.appendChild(day);
  }
}

/* ================= CRUD ================= */
async function saveTask(){
  await supabaseClient.from("tasks").insert({
    task_date: formatDateLocal(
      current.getFullYear(),
      current.getMonth(),
      selectedDay
    ),
    text: taskText.value,
    person: taskPerson.value,
    type: taskType.value
  });

  modal.style.display="none";
  taskText.value="";
  await render();
}

async function toggleDone(t){
  await supabaseClient.from("tasks")
    .update({done:!t.done}).eq("id",t.id);
  await render();
}

async function removeTask(id){
  await supabaseClient.from("tasks").delete().eq("id",id);
  await render();
}

async function dropTask(day){
  if(!dragTask) return;
  await supabaseClient.from("tasks")
    .update({
      task_date: formatDateLocal(
        current.getFullYear(),
        current.getMonth(),
        day
      )
    })
    .eq("id",dragTask.id);
  dragTask=null;
  await render();
}

/* ================= EVENTS ================= */
prev.onclick=()=>{current.setMonth(current.getMonth()-1);render();}
next.onclick=()=>{current.setMonth(current.getMonth()+1);render();}
addTaskBtn.onclick=saveTask;
modal.onclick=e=>{ if(e.target===modal) modal.style.display="none"; }

/* ================= INIT SELECT ================= */
Object.keys(PEOPLE).forEach(p=>{
  taskPerson.innerHTML+=`<option>${p}</option>`;
});
TYPES.forEach(t=>{
  taskType.innerHTML+=`<option>${t}</option>`;
});

/* ================= REALTIME (FREE) ================= */
supabaseClient
  .channel("tasks-live")
  .on("postgres_changes",
    {event:"*",schema:"public",table:"tasks"},
    ()=>render()
  )
  .subscribe();

/* ================= START ================= */
render();
</script>
</body>
</html>
