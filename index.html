<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>

/* ================= BASE ================= */
body{
margin:0;
font-family:system-ui;
background:#0f1115;
color:#eaeaea;
overflow:hidden;
}

header{
padding:10px 16px;
display:flex;
justify-content:space-between;
align-items:center;
}

header button{
background:#1f2228;
color:#fff;
border:none;
padding:6px 10px;
cursor:pointer;
}

/* ================= WEEK ================= */
.weekdays{
display:grid;
grid-template-columns:repeat(7,1fr);
background:#14161b;
border-bottom:1px solid #24262b
}

.weekdays div{
text-align:center;
padding:6px 0;
font-size:12px;
opacity:.7
}

/* ================= CALENDAR ================= */
.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
height:calc(100vh - 210px);
overflow:auto
}

.day{
border:1px solid #24262b;
padding:6px;
font-size:12px;
transition:.15s;
}

.day.drag-over{
background:#1a1d24;
}

.day-number{
opacity:.6;
margin-bottom:4px;
}

/* ================= TASK ================= */
.task{
position:relative;
padding:6px;
border-radius:6px;
margin-bottom:4px;
cursor:grab;
color:#000;
transition:.18s ease;
}

.task.dragging{
opacity:.4;
transform:scale(.97);
}

.task.readonly{
cursor:default;
opacity:.85;
}

.task.done{
opacity:.45;
transform:scale(.98);
filter:grayscale(.2);
}

.task.done strong{
text-decoration:line-through;
}

.task-type{
font-size:10px;
opacity:.8;
}

/* icons */
.delete,.copy-btn{
position:absolute;
bottom:2px;
font-size:14px;
cursor:pointer;
opacity:0;
}

.delete{right:6px}
.copy-btn{right:22px}

.task:hover .delete,
.task:hover .copy-btn,
.task:active .delete,
.task:active .copy-btn{
opacity:1;
}

.add{
opacity:.5;
cursor:pointer;
font-size:11px
}
.add:hover{opacity:1}

/* ================= MODAL ================= */
.modal{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:none;
align-items:center;
justify-content:center;
}

.modal-box{
background:#1b1d22;
padding:16px;
border-radius:10px;
width:260px;
}

.modal-box input,
.modal-box select{
width:100%;
margin-bottom:8px;
padding:6px;
background:#1f2228;
color:#fff;
border:1px solid #333
}

/* ================= FILTER ================= */
.filter-bar{
display:flex;
gap:8px;
padding:8px 16px
}

.filter-bar select{
background:#1f2228;
color:#fff;
border:none;
padding:6px
}

/* ================= TOAST ================= */
.toast{
position:fixed;
bottom:50px;
left:50%;
transform:translateX(-50%);
background:#333;
color:#fff;
padding:8px 14px;
border-radius:6px;
font-size:12px;
opacity:0;
transition:.25s;
}

.toast.show{opacity:1}

/* ================= EDIT ================= */
.edit-bar{
position:fixed;
bottom:10px;
left:50%;
transform:translateX(-50%);
display:flex;
gap:6px
}

.edit-bar input{
background:#1f2228;
border:1px solid #333;
color:#fff;
padding:6px;
width:120px
}

.edit-bar button{
background:#2e7d32;
border:none;
color:#fff;
padding:6px 10px;
cursor:pointer
}

</style>
</head>

<body>

<header>
<button onclick="changeMonth(-1)">←</button>
<div id="title"></div>
<button onclick="changeMonth(1)">→</button>
</header>

<div class="filter-bar">
<select id="filterPerson">
<option value="">All people</option>
</select>

<select id="viewMode">
<option value="normal">Normal</option>
<option value="assign">Assign order</option>
</select>
</div>

<div class="weekdays">
<div>Mon</div><div>Tue</div><div>Wed</div>
<div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div id="calendar" class="calendar"></div>

<!-- MODAL -->
<div class="modal" id="modal" onclick="closeModal(event)">
<div class="modal-box">
<input id="taskText" placeholder="Task name">
<select id="taskPerson"></select>
<select id="taskType"></select>
<select id="taskAM"></select>
<button onclick="saveTask()">Add Task</button>
</div>
</div>

<div class="toast" id="toast"></div>

<div class="edit-bar">
<input id="editCode" placeholder="Edit code">
<button onclick="unlockEdit()">Unlock</button>
</div>

<script>

/* ================= CONFIG ================= */

const EDIT_CODE="TEAM2026";

const TELEGRAM_WEBHOOK="YOUR_GAS_WEBHOOK";

/* ===== TELEGRAM ===== */
async function sendTelegram(data){
try{
await fetch(TELEGRAM_WEBHOOK,{
method:"POST",
headers:{ "Content-Type":"text/plain" },
body:JSON.stringify(data)
});
}catch(e){console.log(e);}
}

/* ===== SUPABASE ===== */
const supabaseClient=supabase.createClient(
"https://letbykkygmmdxbmnemam.supabase.co",
"sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);

/* ===== DATA ===== */

const PEOPLE_ORDER=["Tony","Davis","Alex","Lucas","Allen","Hayden","Leo","Dante"];

const PEOPLE={
Tony:"#ff8a80",
Allen:"#90caf9",
Davis:"#b39ddb",
Alex:"#ffe082",
Lucas:"#b0bec5",
Hayden:"#f48fb1",
Leo:"#ce93d8",
Dante:"#a5d6a7"
};

const TYPES=["Design + QR","Design","Menu + QR","Menu","QR"];
const AM_LIST=["None","Luna","Nancy","Issac","Elysia","Ray"];

let current=new Date();
let cache={};
let selectedDay=null;

let canEdit=localStorage.getItem("canEdit")==="1";
let dragTask=null;
let dragFromDay=null;
let dragFromIndex=null;

/* ================= HELPERS ================= */

let toastTimer;
function toast(msg,color="#333"){
clearTimeout(toastTimer);
toastEl.textContent=msg;
toastEl.style.background=color;
toastEl.classList.add("show");
toastTimer=setTimeout(()=>toastEl.classList.remove("show"),1400);
}

function formatDate(y,m,d){
return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ================= LOAD ================= */

async function load(){
const y=current.getFullYear();
const m=current.getMonth();

const start=formatDate(y,m,1);
const end=formatDate(y,m,new Date(y,m+1,0).getDate());

const {data}=await supabaseClient
.from("tasks")
.select("*")
.gte("task_date",start)
.lte("task_date",end)
.order("sort_order");

cache={};

(data||[]).forEach(t=>{
const d=+t.task_date.slice(8,10);
(cache[d]??=[]).push(t);
});
}

/* ================= RENDER ================= */

async function render(){
await load();
renderCalendarOnly();
}

function renderCalendarOnly(){

calendar.innerHTML="";
title.textContent=`${current.getMonth()+1}/${current.getFullYear()}`;

const days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
const offset=(new Date(current.getFullYear(),current.getMonth(),1).getDay()+6)%7;

for(let i=0;i<offset;i++)
calendar.appendChild(document.createElement("div"));

for(let d=1;d<=days;d++){

const day=document.createElement("div");
day.className="day";

day.innerHTML=`<div class="day-number">${d}</div>`;

let tasks=[...(cache[d]||[])];

tasks.forEach(t=>{

const el=document.createElement("div");
el.className="task"+(t.done?" done":"");
el.style.background=PEOPLE[t.person];
el.draggable=canEdit;

el.innerHTML=
`<strong>${t.text}</strong>
<div class="task-type">${t.person} • ${t.type}</div>`;

el.ondragstart=()=>{
dragTask=t;
dragFromDay=d;
dragFromIndex=cache[d].indexOf(t);
el.classList.add("dragging");
};

el.ondragend=()=>{
el.classList.remove("dragging");
};

if(canEdit)
el.onclick=()=>toggleDone(t);

day.appendChild(el);

});

if(canEdit){
const add=document.createElement("div");
add.className="add";
add.textContent="+ Add task";
add.onclick=()=>openModal(d);
day.appendChild(add);
}

calendar.appendChild(day);
}

}

/* ================= TASK ================= */

async function saveTask(){

if(!taskText.value)return;

const task={
task_date:formatDate(current.getFullYear(),current.getMonth(),selectedDay),
text:taskText.value,
person:taskPerson.value,
type:taskType.value,
am:taskAM.value,
done:false,
sort_order:(cache[selectedDay]?.length||0)
};

await supabaseClient.from("tasks").insert(task);

sendTelegram({
event:"new",
message:`New task: ${task.text}`
});

closeModal();
render();
}

async function toggleDone(t){

t.done=!t.done;

await supabaseClient
.from("tasks")
.update({done:t.done})
.eq("id",t.id);

if(t.done){
sendTelegram({
event:"done",
message:`Completed: ${t.text}`
});
}

renderCalendarOnly();
}

/* ================= UI ================= */

function openModal(d){
selectedDay=d;
modal.style.display="flex";
setTimeout(()=>taskText.focus(),50);
}

function closeModal(e){
if(!e||e.target===modal)
modal.style.display="none";
}

function unlockEdit(){
if(editCode.value===EDIT_CODE){
canEdit=true;
localStorage.setItem("canEdit","1");
toast("Unlocked","#2e7d32");
renderCalendarOnly();
}
}

function changeMonth(n){
current.setMonth(current.getMonth()+n);
render();
}

/* ================= INIT ================= */

Object.keys(PEOPLE).forEach(p=>{
taskPerson.innerHTML+=`<option>${p}</option>`;
filterPerson.innerHTML+=`<option>${p}</option>`;
});

TYPES.forEach(t=>taskType.innerHTML+=`<option>${t}</option>`);
AM_LIST.forEach(a=>taskAM.innerHTML+=`<option>${a}</option>`);

render();

supabaseClient.channel("tasks-rt")
.on("postgres_changes",
{event:"*",schema:"public",table:"tasks"},
()=>renderCalendarOnly()
)
.subscribe();

</script>
</body>
</html>
