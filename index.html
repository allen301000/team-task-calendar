<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Team Task Calendar</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f4f6f8;padding:20px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{background:#fff;border:1px solid #ddd;border-radius:6px;padding:6px;min-height:120px;cursor:pointer}
.day strong{display:block;margin-bottom:4px}
.task{background:#e3edff;margin-top:4px;padding:4px 6px;border-radius:4px;font-size:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
.modal-content{background:#fff;padding:16px;width:320px;border-radius:8px}
.modal-content input{width:100%;margin-bottom:8px;padding:6px}
</style>
</head>

<body>

<h2 id="monthLabel"></h2>
<div id="calendar" class="calendar"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Thêm task</h3>
    <input id="taskText" placeholder="Task name">
    <input id="taskPerson" placeholder="Person">
    <input id="taskType" placeholder="Type">
    <div style="text-align:right">
      <button id="closeModal">Cancel</button>
      <button id="saveTask">Save</button>
    </div>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://letbykkygmmdxbmnemam.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo";

/* ⛔ KHÔNG DÙNG TÊN supabase */
const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ================= STATE ================= */
const calendarEl = document.getElementById("calendar");
const modal = document.getElementById("modal");
const taskText = document.getElementById("taskText");
const taskPerson = document.getElementById("taskPerson");
const taskType = document.getElementById("taskType");

let current = new Date();
let selectedDay = null;

/* ================= UTILS ================= */
const fmt = d => d.toISOString().slice(0,10);
const daysInMonth = (y,m)=>new Date(y,m+1,0).getDate();

/* ================= RENDER ================= */
async function renderCalendar(){
  calendarEl.innerHTML="";

  const y=current.getFullYear();
  const m=current.getMonth();
  document.getElementById("monthLabel").textContent =
    current.toLocaleString("vi",{month:"long",year:"numeric"});

  const start=fmt(new Date(y,m,1));
  const end=fmt(new Date(y,m+1,0));

  const { data } = await supabaseClient
    .from("tasks")
    .select("*")
    .gte("task_date",start)
    .lte("task_date",end);

  const map={};
  (data||[]).forEach(t=>(map[t.task_date]??=[]).push(t));

  for(let d=1;d<=daysInMonth(y,m);d++){
    const date=fmt(new Date(y,m,d));
    const cell=document.createElement("div");
    cell.className="day";
    cell.dataset.day=d;
    cell.innerHTML=`<strong>${d}</strong>`;

    (map[date]||[]).forEach(t=>{
      const el=document.createElement("div");
      el.className="task";
      el.textContent=`${t.text} (${t.person})`;
      cell.appendChild(el);
    });

    calendarEl.appendChild(cell);
  }
}

/* ================= EVENTS ================= */
calendarEl.onclick=e=>{
  const day=e.target.closest(".day");
  if(!day)return;
  selectedDay=Number(day.dataset.day);
  modal.style.display="flex";
};

closeModal.onclick=()=>modal.style.display="none";
saveTask.onclick=async()=>{
  if(!taskText.value||!selectedDay)return;

  await supabaseClient.from("tasks").insert({
    task_date:fmt(new Date(current.getFullYear(),current.getMonth(),selectedDay)),
    text:taskText.value,
    person:taskPerson.value,
    type:taskType.value
  });

  modal.style.display="none";
  taskText.value=taskPerson.value=taskType.value="";
};

/* ================= REALTIME – FREE ================= */
supabaseClient
  .channel("tasks-live")
  .on(
    "postgres_changes",
    {event:"*",schema:"public",table:"tasks"},
    renderCalendar
  )
  .subscribe();

/* ================= INIT ================= */
renderCalendar();
</script>

</body>
</html>
