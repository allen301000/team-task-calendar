<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0f1115;color:#eaeaea}
header{padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
header button{background:#1f2228;color:#fff;border:none;padding:6px 10px;cursor:pointer}

.weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#14161b;border-bottom:1px solid #24262b}
.weekdays div{text-align:center;padding:6px 0;font-size:12px;opacity:.7}

.calendar{display:grid;grid-template-columns:repeat(7,1fr);height:calc(100vh - 210px)}
.day{border:1px solid #24262b;padding:6px;font-size:12px}
.day-number{opacity:.6;margin-bottom:4px}

.task{
position:relative;
padding:6px;
border-radius:6px;
margin-bottom:4px;
cursor:grab;
color:#000;
}
.task.readonly{cursor:default;opacity:.85}
.task.done{opacity:.45;filter:grayscale(.15)}
.task.done strong{text-decoration:line-through}

.task-type{font-size:10px;opacity:.8}

.delete,.copy-btn{
position:absolute;
bottom:2px;
font-size:14px;
cursor:pointer;
opacity:0;
}
.delete{right:6px}
.copy-btn{right:22px}
.task:hover .delete,
.task:hover .copy-btn{opacity:1}

.add{opacity:.5;cursor:pointer;font-size:11px}
.add:hover{opacity:1}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-box{background:#1b1d22;padding:16px;border-radius:10px;width:260px}

.modal-box input,.modal-box select{
width:100%;
margin-bottom:8px;
padding:6px;
background:#1f2228;
color:#fff;
border:1px solid #333
}

.toast{
position:fixed;bottom:50px;left:50%;
transform:translateX(-50%);
background:#333;color:#fff;
padding:8px 14px;border-radius:6px;
font-size:12px;opacity:0;transition:.25s;
}
.toast.show{opacity:1}

.edit-bar{
position:fixed;bottom:10px;left:50%;
transform:translateX(-50%);
display:flex;gap:6px
}
.edit-bar input{
background:#1f2228;border:1px solid #333;
color:#fff;padding:6px;width:120px
}
.edit-bar button{
background:#2e7d32;border:none;
color:#fff;padding:6px 10px;cursor:pointer
}
</style>
</head>

<body>

<header>
<button onclick="changeMonth(-1)">←</button>
<div id="title"></div>
<button onclick="changeMonth(1)">→</button>
</header>

<div class="calendar" id="calendar"></div>

<div class="modal" id="modal" onclick="closeModal(event)">
<div class="modal-box">
<input id="taskText" placeholder="Task name">
<select id="taskPerson"></select>
<select id="taskType"></select>
<select id="taskAM"></select>
<button onclick="saveTask()">Save</button>
</div>
</div>

<div class="toast" id="toast"></div>

<div class="edit-bar">
<input id="editCode" placeholder="Edit code">
<button onclick="unlockEdit()">Unlock</button>
</div>

<script>

/* ================= CONFIG ================= */
const EDIT_CODE="TEAM2026";

const TELEGRAM_WEBHOOK="YOUR_GAS_WEBHOOK";

async function sendTelegram(data){
try{
await fetch(TELEGRAM_WEBHOOK,{
method:"POST",
headers:{"Content-Type":"text/plain"},
body:JSON.stringify(data)
});
}catch(e){console.error(e);}
}

const supabaseClient=supabase.createClient(
"YOUR_SUPABASE_URL",
"YOUR_SUPABASE_PUBLIC_KEY"
);

/* ================= DATA ================= */

const PEOPLE_ORDER=["Tony","Davis","Alex","Lucas"];
const PEOPLE={
Tony:"#ff8a80",
Davis:"#b39ddb",
Alex:"#ffe082",
Lucas:"#b0bec5"
};

const AM_LIST=["None","Luna","Nancy","Ray"];
const TYPES=["Design","Menu","QR"];

let current=new Date();
let selectedDay=null;
let cache={};
let editingTask=null;
let canEdit=localStorage.getItem("canEdit")==="1";

let dragTask=null,dragFromDay=null,dragFromIndex=null;

/* ================= HELPERS ================= */

function toast(msg,color="#333"){
toastEl.textContent=msg;
toastEl.style.background=color;
toastEl.classList.add("show");
setTimeout(()=>toastEl.classList.remove("show"),1200);
}

function formatDate(y,m,d){
return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ================= LOAD ================= */

async function load(){
const y=current.getFullYear(),m=current.getMonth();
const start=formatDate(y,m,1);
const end=formatDate(y,m,new Date(y,m+1,0).getDate());

const {data}=await supabaseClient
.from("tasks")
.select("*")
.gte("task_date",start)
.lte("task_date",end)
.order("sort_order");

cache={};
(data||[]).forEach(t=>{
const d=+t.task_date.slice(8,10);
(cache[d]??=[]).push(t);
});
}

/* ================= RENDER ================= */

async function render(){await load();renderCalendarOnly();}

function renderCalendarOnly(){

calendar.innerHTML="";
title.textContent=`${current.getMonth()+1}/${current.getFullYear()}`;

taskAM.innerHTML="";
AM_LIST.forEach(a=>taskAM.innerHTML+=`<option>${a}</option>`);

const days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();

for(let d=1;d<=days;d++){

const day=document.createElement("div");
day.className="day";
day.innerHTML=`<div class="day-number">${d}</div>`;

(cache[d]||[]).forEach(t=>{

const el=document.createElement("div");
el.className="task"+(t.done?" done":"");
el.style.background=PEOPLE[t.person];
el.draggable=canEdit;

if(canEdit){

el.onclick=()=>toggleDone(t);

el.oncontextmenu=e=>{
e.preventDefault();
openEditTask(t);
};

el.ondragstart=()=>{
dragTask=t;
dragFromDay=d;
dragFromIndex=cache[d].indexOf(t);
};
}

el.innerHTML=
`<strong>${t.text}</strong>
<div class="task-type">${t.person} • ${t.type} (AM:${t.am})</div>`;

day.appendChild(el);
});

if(canEdit){
const add=document.createElement("div");
add.className="add";
add.textContent="+ Add task";
add.onclick=()=>openModal(d);
day.appendChild(add);
}

calendar.appendChild(day);
}
}

/* ================= EDIT ================= */

function openEditTask(task){

editingTask=task;
selectedDay=+task.task_date.slice(8,10);

taskText.value=task.text;
taskPerson.value=task.person;
taskType.value=task.type;
taskAM.value=task.am;

modal.style.display="flex";
}

/* ================= SAVE ================= */

async function saveTask(){

if(!canEdit||!selectedDay||!taskText.value)return;

const date=formatDate(
current.getFullYear(),
current.getMonth(),
selectedDay
);

/* ===== EDIT MODE ===== */
if(editingTask){

editingTask.text=taskText.value;
editingTask.person=taskPerson.value;
editingTask.type=taskType.value;
editingTask.am=taskAM.value;

renderCalendarOnly();
closeModal();

await supabaseClient
.from("tasks")
.update({
text:editingTask.text,
person:editingTask.person,
type:editingTask.type,
am:editingTask.am
})
.eq("id",editingTask.id);

sendTelegram({
event:"edit",
person:editingTask.person,
am:editingTask.am,
message:`✏️ Task Updated\n${editingTask.text}`
});

editingTask=null;
toast("Task updated","#2e7d32");
return;
}

/* ===== DUPLICATE CHECK FIX ===== */

const isDuplicate=(cache[selectedDay]||[])
.some(t=>
t.text.trim().toLowerCase()===taskText.value.trim().toLowerCase()
&& t.person===taskPerson.value
&& (t.am||"")===taskAM.value
);

if(isDuplicate){
toast("Task already exists","#b71c1c");
return;
}

/* ===== CREATE ===== */

const task={
task_date:date,
text:taskText.value,
person:taskPerson.value,
type:taskType.value,
am:taskAM.value,
done:false,
sort_order:(cache[selectedDay]?.length||0)
};

(cache[selectedDay]??=[]).push(task);

renderCalendarOnly();
closeModal();

await supabaseClient.from("tasks").insert(task);

sendTelegram({
event:"new",
person:task.person,
am:task.am,
message:`${task.text}\n${task.task_date}`
});

toast("Task added","#2e7d32");
}

/* ================= DONE ================= */

async function toggleDone(t){
t.done=!t.done;
renderCalendarOnly();

await supabaseClient
.from("tasks")
.update({done:t.done})
.eq("id",t.id);
}

/* ================= UI ================= */

function openModal(d){
selectedDay=d;
editingTask=null;
modal.style.display="flex";
}

function closeModal(e){
if(!e||e.target===modal){
modal.style.display="none";
taskText.value="";
editingTask=null;
}
}

function unlockEdit(){
if(editCode.value===EDIT_CODE){
canEdit=true;
localStorage.setItem("canEdit","1");
toast("Unlocked","#2e7d32");
renderCalendarOnly();
}
}

function changeMonth(n){
current.setMonth(current.getMonth()+n);
render();
}

/* ================= INIT ================= */

Object.keys(PEOPLE).forEach(p=>{
taskPerson.innerHTML+=`<option>${p}</option>`;
});

TYPES.forEach(t=>{
taskType.innerHTML+=`<option>${t}</option>`;
});

render();

supabaseClient.channel("tasks-rt")
.on("postgres_changes",
{event:"*",schema:"public",table:"tasks"},
render)
.subscribe();

</script>
</body>
</html>
