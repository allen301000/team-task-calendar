<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0f1115;color:#eaeaea}
header{padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
header button{background:#1f2228;color:#fff;border:none;padding:6px 10px;cursor:pointer}

.weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#14161b;border-bottom:1px solid #24262b}
.weekdays div{text-align:center;padding:6px 0;font-size:12px;opacity:.7}

.calendar{display:grid;grid-template-columns:repeat(7,1fr);height:calc(100vh - 210px)}
.day{border:1px solid #24262b;padding:6px;font-size:12px}
.day-number{opacity:.6;margin-bottom:4px}

.task{
position:relative;
padding:6px;
border-radius:6px;
margin-bottom:4px;
cursor:grab;
color:#000;
}

.task.readonly{cursor:default;opacity:.85}
.task.done{opacity:.45;filter:grayscale(.15)}

.task.done::after{
content:"Completed";
position:absolute;
top:2px;
right:6px;
font-size:9px;
background:#1b5e20;
color:#fff;
padding:2px 6px;
border-radius:10px;
}

.task.done strong{text-decoration:line-through}

.task-type{font-size:10px;opacity:.8}

.delete,.copy-btn{
position:absolute;
bottom:2px;
font-size:14px;
cursor:pointer;
opacity:0;
}

.delete{right:6px}
.copy-btn{right:22px}

.task:hover .delete,
.task:hover .copy-btn{opacity:1}

.add{opacity:.5;cursor:pointer;font-size:11px}
.add:hover{opacity:1}

.modal{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:none;
align-items:center;
justify-content:center
}

.modal-box{
background:#1b1d22;
padding:16px;
border-radius:10px;
width:260px
}

.modal-box input,
.modal-box select{
width:100%;
margin-bottom:8px;
padding:6px;
background:#1f2228;
color:#fff;
border:1px solid #333
}

.toast{
position:fixed;
bottom:50px;
left:50%;
transform:translateX(-50%);
background:#333;
color:#fff;
padding:8px 14px;
border-radius:6px;
font-size:12px;
opacity:0;
transition:.25s;
}

.toast.show{opacity:1}
</style>
</head>

<body>

<header>
<button onclick="changeMonth(-1)">‚Üê</button>
<div id="title"></div>
<button onclick="changeMonth(1)">‚Üí</button>
</header>

<div class="calendar" id="calendar"></div>

<div class="modal" id="modal" onclick="closeModal(event)">
<div class="modal-box">
<input id="taskText" placeholder="Task name">
<select id="taskPerson"></select>
<select id="taskType"></select>
<select id="taskAM"></select>
<button onclick="saveTask()">Save</button>
</div>
</div>

<div class="toast" id="toast"></div>

<script>

/* ================= CONFIG ================= */

const EDIT_CODE="TEAM2026";

const TELEGRAM_WEBHOOK="https://script.google.com/macros/s/AKfycbxtlxQDdsln4WSOEmx23uWMeXwrgrsfOvrOJ0RoLO-elSBviRLEttOCXvBCh2QvSU3vAg/exec";

async function sendTelegram(data){
try{
await fetch(TELEGRAM_WEBHOOK,{
method:"POST",
headers:{"Content-Type":"text/plain;charset=utf-8"},
body:JSON.stringify(data)
});
}catch(e){
console.error(e);
}
}

const supabaseClient=supabase.createClient(
"https://letbykkygmmdxbmnemam.supabase.co",
"sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);
  /* ================= DATA ================= */

const PEOPLE_ORDER=["Tony","Davis","Alex","Lucas","Allen","Hayden","Leo","Dante"];

const PEOPLE={
Tony:"#ff8a80",
Allen:"#90caf9",
Davis:"#b39ddb",
Alex:"#ffe082",
Lucas:"#b0bec5",
Hayden:"#f48fb1",
Leo:"#ce93d8",
Dante:"#a5d6a7"
};

const AM_LIST=[
"None","Luna","Nancy","Issac","Elysia","Ray",
"Annie","Zoe","Wendy","Bruce","Sofia","Selena",
"Lucie","Anna","Josie","Tera","Mochi","Hanie",
"Emma","Mia","Jane","Rosie"
];

const TYPES=["Design + QR","Design","Menu + QR","Menu","QR"];

let current=new Date();
let selectedDay=null;
let cache={};

let canEdit=localStorage.getItem("canEdit")==="1";

let dragTask=null;
let dragFromDay=null;
let dragFromIndex=null;

let editingTask=null;

/* ================= HELPERS ================= */

function toast(msg,color="#333"){
toast.textContent=msg;
toast.style.background=color;
toast.classList.add("show");
setTimeout(()=>toast.classList.remove("show"),1200);
}

function formatDate(y,m,d){
return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ================= LOAD ================= */

async function load(){

const y=current.getFullYear();
const m=current.getMonth();

const start=formatDate(y,m,1);
const end=formatDate(y,m,new Date(y,m+1,0).getDate());

const {data}=await supabaseClient
.from("tasks")
.select("*")
.gte("task_date",start)
.lte("task_date",end)
.order("sort_order",{ascending:true});

cache={};

(data||[]).forEach(t=>{
const d=+t.task_date.slice(8,10);
(cache[d]??=[]).push(t);
});
}

/* ================= RENDER ================= */

async function render(){
await load();
renderCalendarOnly();
}

function renderCalendarOnly(){

calendar.innerHTML="";

title.textContent=
`Th√°ng ${current.getMonth()+1}/${current.getFullYear()}`;

taskAM.innerHTML="";
AM_LIST.forEach(a=>{
taskAM.innerHTML+=`<option>${a}</option>`;
});

const days=
new Date(
current.getFullYear(),
current.getMonth()+1,
0
).getDate();

for(let d=1;d<=days;d++){

const day=document.createElement("div");
day.className="day";
day.innerHTML=`<div class="day-number">${d}</div>`;

(cache[d]||[]).forEach(t=>{

const el=document.createElement("div");

el.className=
"task"+
(t.done?" done":"")+
(canEdit?"":" readonly");

el.style.background=PEOPLE[t.person];
el.draggable=canEdit;

/* CLICK DONE */
if(canEdit){
el.onclick=()=>toggleDone(t);

/* RIGHT CLICK EDIT */
el.oncontextmenu=e=>{
e.preventDefault();
openEditTask(t);
};
}

el.ondragstart=()=>{
dragTask=t;
dragFromDay=d;
dragFromIndex=cache[d].indexOf(t);
};

el.innerHTML=
`<strong>${t.text}</strong>
<div class="task-type">
${t.person} ‚Ä¢ ${t.type}
(AM:${t.am||"N/A"})
</div>`;

day.appendChild(el);
});

/* ADD BUTTON */
if(canEdit){
const add=document.createElement("div");
add.className="add";
add.textContent="+ Add task";
add.onclick=()=>openModal(d);
day.appendChild(add);
}

calendar.appendChild(day);
}
}

/* ================= EDIT ================= */

function openEditTask(task){

editingTask=task;

selectedDay=
+task.task_date.slice(8,10);

taskText.value=task.text;
taskPerson.value=task.person;
taskType.value=task.type;
taskAM.value=task.am||"None";

modal.style.display="flex";
}

/* ================= SAVE ================= */

async function saveTask(){

if(!canEdit||!selectedDay||!taskText.value)
return;

const selectedAM=taskAM.value;

const date=formatDate(
current.getFullYear(),
current.getMonth(),
selectedDay
);

/* ===== EDIT MODE ===== */
if(editingTask){

editingTask.text=taskText.value;
editingTask.person=taskPerson.value;
editingTask.type=taskType.value;
editingTask.am=selectedAM;

renderCalendarOnly();
closeModal();

await supabaseClient
.from("tasks")
.update({
text:editingTask.text,
person:editingTask.person,
type:editingTask.type,
am:editingTask.am
})
.eq("id",editingTask.id);

sendTelegram({
event:"edit",
person:editingTask.person,
am:editingTask.am,
message:
`‚úèÔ∏è <b>Task Updated</b>\n${editingTask.text}`
});

editingTask=null;

toast("Task updated","#2e7d32");
return;
}

/* ===== DUPLICATE FIX ===== */

const isDuplicate=
(cache[selectedDay]||[])
.some(t=>
t.text.trim().toLowerCase()
===
taskText.value.trim().toLowerCase()
&& t.person===taskPerson.value
&& (t.am||"")===selectedAM
);

if(isDuplicate){
toast("Task already exists","#b71c1c");
return;
}

/* ===== CREATE ===== */

const task={
task_date:date,
text:taskText.value,
person:taskPerson.value,
type:taskType.value,
am:selectedAM,
done:false,
sort_order:
(cache[selectedDay]?.length||0)
};

(cache[selectedDay]??=[]).push(task);

renderCalendarOnly();
closeModal();

await supabaseClient
.from("tasks")
.insert(task);

sendTelegram({
event:"new",
person:task.person,
am:task.am,
message:
`<strong>${task.text}</strong>
 AM:${task.am}
 üìÖ ${task.task_date}`
});

toast("Task added","#2e7d32");
}

/* ================= DONE ================= */

async function toggleDone(t){

t.done=!t.done;

renderCalendarOnly();

await supabaseClient
.from("tasks")
.update({done:t.done})
.eq("id",t.id);

if(t.done){
sendTelegram({
event:"done",
person:t.person,
am:t.am,
message:`‚úÖ Completed\n${t.text}`
});
}
}

/* ================= MODAL ================= */

function openModal(d){
selectedDay=d;
editingTask=null;
modal.style.display="flex";
}

function closeModal(e){
if(!e||e.target===modal){
modal.style.display="none";
editingTask=null;
taskText.value="";
}
}

/* ================= MONTH ================= */

function changeMonth(n){
current.setMonth(current.getMonth()+n);
render();
}

/* ================= INIT ================= */

Object.keys(PEOPLE).forEach(p=>{
taskPerson.innerHTML+=`<option>${p}</option>`;
});

TYPES.forEach(t=>{
taskType.innerHTML+=`<option>${t}</option>`;
});

render();

/* REALTIME */

supabaseClient
.channel("tasks-rt")
.on(
"postgres_changes",
{event:"*",schema:"public",table:"tasks"},
render
)
.subscribe();

</script>
</body>
</html>
