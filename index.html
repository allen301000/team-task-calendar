<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0f1115;color:#eaeaea}
header{padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
header button{background:#1f2228;color:#fff;border:none;padding:6px 10px;cursor:pointer}

.weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#14161b;border-bottom:1px solid #24262b}
.weekdays div{text-align:center;padding:6px 0;font-size:12px;opacity:.7}

.calendar{display:grid;grid-template-columns:repeat(7,1fr);height:calc(100vh - 240px)}
.day{border:1px solid #24262b;padding:6px;font-size:12px}
.day-number{opacity:.6;margin-bottom:4px}

.task{
  position:relative;
  padding:6px;
  border-radius:6px;
  margin-bottom:4px;
  cursor:grab;
  color:#000;
  transition:.2s;
}
.task.readonly{cursor:default;opacity:.85}

/* DONE ‚Äì gi·ªØ m√†u g·ªëc */
.task.done{
  opacity:.45;
  filter:grayscale(.15);
}
.task.done::after{
  content:"Completed";
  position:absolute;
  top:2px;
  right:6px;
  font-size:9px;
  padding:2px 6px;
  border-radius:10px;
  background:#2e7d32;
  color:#fff;
}
.task.done strong{text-decoration:line-through}

/* DUPLICATE */
.task.duplicate{
  outline:2px solid #ff5252;
  box-shadow:0 0 0 2px rgba(255,82,82,.4);
}

.task-type{font-size:10px;opacity:.8}

.delete,.copy-btn{
  position:absolute;
  bottom:2px;
  font-size:14px;
  cursor:pointer;
  opacity:0;
}
.delete{right:6px}
.copy-btn{right:22px}
.task:hover .delete,
.task:hover .copy-btn{opacity:1}

.add{opacity:.5;cursor:pointer;font-size:11px}
.add:hover{opacity:1}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-box{background:#1b1d22;padding:16px;border-radius:10px;width:260px}
.modal-box input,.modal-box select{width:100%;margin-bottom:8px;padding:6px}

.filter-bar{display:flex;gap:8px;padding:8px 16px}
.filter-bar select{background:#1f2228;color:#fff;border:none;padding:6px}

/* STATS */
.stats-toggle{
  position:fixed;bottom:90px;right:12px;
  background:#1f2228;padding:6px 10px;
  cursor:pointer;border-radius:6px
}
.stats{
  position:fixed;bottom:130px;right:12px;
  background:#1b1d22;padding:12px;
  border-radius:8px;font-size:12px;
  width:220px;display:none
}
.stats h4{margin:4px 0;border-bottom:1px solid #333}

/* TOAST */
.toast{
  position:fixed;bottom:50px;left:50%;
  transform:translateX(-50%);
  background:#333;color:#fff;
  padding:8px 14px;border-radius:6px;
  font-size:12px;opacity:0;
  transition:.25s;pointer-events:none
}
.toast.show{opacity:1}

/* EDIT BAR */
.edit-bar{
  position:fixed;bottom:10px;left:50%;
  transform:translateX(-50%);
  display:flex;gap:6px
}
.edit-bar input{
  background:#1f2228;border:1px solid #333;
  color:#fff;padding:6px;width:120px
}
.edit-bar button{
  background:#2e7d32;border:none;
  color:#fff;padding:6px 10px;cursor:pointer
}
</style>
</head>

<body>

<header>
  <button onclick="changeMonth(-1)">‚Üê</button>
  <div id="title"></div>
  <button onclick="changeMonth(1)">‚Üí</button>
</header>

<div class="filter-bar">
  <select id="filterPerson"><option value="">All people</option></select>
</div>

<div class="weekdays">
  <div>Mon</div><div>Tue</div><div>Wed</div>
  <div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div class="calendar" id="calendar"></div>

<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-box">
    <input id="taskText" placeholder="Task name">
    <select id="taskPerson"></select>
    <select id="taskType"></select>
    <button onclick="saveTask()">Add Task</button>
  </div>
</div>

<div class="stats-toggle" onclick="toggleStats()">üìä Stats</div>
<div class="stats" id="stats"></div>

<div class="toast" id="toast"></div>

<div class="edit-bar">
  <input id="editCode" placeholder="Edit code">
  <button onclick="unlockEdit()">Unlock</button>
</div>

<script>
/* ================= CONFIG ================= */
const EDIT_CODE="TEAM2026";

const supabaseClient=supabase.createClient(
  "https://letbykkygmmdxbmnemam.supabase.co",
  "sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);

const PEOPLE={
  Tony:"#D5F0C1",Allen:"#F96E5B",Davis:"#FFE2AF",
  Alex:"#F7CFD8",Lucas:"#91DDCF",Hayden:"#f48fb1",
  Leo:"#F8FAE5",Dante:"#fff"
};
const TYPES=["Design+QR","Menu+QR","Design","Menu","QR"];

/* ================= STATE ================= */
let current=new Date();
let selectedDay=null;
let dragTask=null;
let cache={};
let activePersonFilter="";
let canEdit=localStorage.getItem("canEdit")==="1";

/* ================= HELPERS ================= */
const toastEl=document.getElementById("toast");
function toast(msg,color="#333"){
  toastEl.textContent=msg;
  toastEl.style.background=color;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"),1500);
}
function normalizeText(str){
  return str.toLowerCase().replace(/\s+/g," ").trim();
}
function formatDate(y,m,d){
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}

/* ================= LOAD ================= */
async function load(){
  const y=current.getFullYear(),m=current.getMonth();
  const start=formatDate(y,m,1);
  const end=formatDate(y,m,new Date(y,m+1,0).getDate());
  const {data}=await supabaseClient
    .from("tasks").select("*")
    .gte("task_date",start).lte("task_date",end);

  cache={};
  (data||[]).forEach(t=>{
    const d=+t.task_date.slice(8,10);
    (cache[d]??=[]).push(t);
  });
}

/* ================= RENDER ================= */
function renderCalendarOnly(){
  calendar.innerHTML="";
  title.textContent=`Th√°ng ${current.getMonth()+1}/${current.getFullYear()}`;

  const flat=Object.values(cache).flat();
  const map={};
  flat.forEach(t=>{
    const k=normalizeText(t.text);
    map[k]=(map[k]||0)+1;
  });

  const days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
  const offset=(new Date(current.getFullYear(),current.getMonth(),1).getDay()+6)%7;
  for(let i=0;i<offset;i++)calendar.appendChild(document.createElement("div"));

  for(let d=1;d<=days;d++){
    const el=document.createElement("div");
    el.className="day";
    el.innerHTML=`<div class="day-number">${d}</div>`;
    if(canEdit){
      el.ondragover=e=>e.preventDefault();
      el.ondrop=()=>dropTask(d);
    }

    (cache[d]||[])
      .filter(t=>!activePersonFilter||t.person===activePersonFilter)
      .forEach(t=>{
        const dup=map[normalizeText(t.text)]>1;

        const task=document.createElement("div");
        task.className=
          "task"+
          (t.done?" done":"")+
          (dup?" duplicate":"")+
          (canEdit?"":" readonly");

        task.style.background=PEOPLE[t.person];
        task.draggable=canEdit;

        if(canEdit){
          task.onclick=()=>toggleDone(t);
          task.ondragstart=()=>dragTask=t;
        }

        task.innerHTML=`<strong>${t.text}</strong>
          <div class="task-type">${t.person} ‚Ä¢ ${t.type}</div>`;

        const copy=document.createElement("span");
        copy.className="copy-btn";
        copy.textContent="üìã";
        copy.onclick=e=>{
          e.stopPropagation();
          navigator.clipboard.writeText(t.text);
          toast("Copied!","#2e7d32");
        };
        task.appendChild(copy);

        if(canEdit){
          const del=document.createElement("span");
          del.className="delete";
          del.textContent="‚úñ";
          del.onclick=e=>{
            e.stopPropagation();
            removeTask(t.id);
          };
          task.appendChild(del);
        }
        el.appendChild(task);
      });

    if(canEdit){
      const add=document.createElement("div");
      add.className="add";
      add.textContent="+ Add task";
      add.onclick=()=>openModal(d);
      el.appendChild(add);
    }
    calendar.appendChild(el);
  }
  renderStats(map,flat);
}

function renderStats(map,flat){
  const done=flat.filter(t=>t.done).length;
  const dup=Object.values(map).filter(v=>v>1).length;
  stats.innerHTML=`
    <h4>Th·ªëng k√™ th√°ng</h4>
    Total: ${flat.length}<br>
    Done: ${done}<br>
    Pending: ${flat.length-done}<br>
    Duplicate: ${dup}
  `;
}

async function render(){await load();renderCalendarOnly();}

/* ================= ACTIONS ================= */
function unlockEdit(){
  if(editCode.value===EDIT_CODE){
    canEdit=true;
    localStorage.setItem("canEdit","1");
    toast("Edit unlocked","#2e7d32");
    renderCalendarOnly();
  }else toast("Wrong code","#b71c1c");
}

async function saveTask(){
  if(!canEdit||!selectedDay||!taskText.value)return;

  const name=normalizeText(taskText.value);
  const exists=Object.values(cache)
    .flat()
    .some(t=>normalizeText(t.text)===name);

  if(exists){
    toast("Task b·ªã tr√πng ‚Äì kh√¥ng th·ªÉ th√™m","#c62828");
    return;
  }

  const task={
    task_date:formatDate(current.getFullYear(),current.getMonth(),selectedDay),
    text:taskText.value,
    person:taskPerson.value,
    type:taskType.value,
    done:false
  };

  await supabaseClient.from("tasks").insert(task);
  toast("Task added","#2e7d32");
  closeModal();
}

async function toggleDone(t){
  t.done=!t.done;
  renderCalendarOnly();
  await supabaseClient.from("tasks").update({done:t.done}).eq("id",t.id);
}

async function removeTask(id){
  await supabaseClient.from("tasks").delete().eq("id",id);
}

async function dropTask(day){
  if(!dragTask)return;
  await supabaseClient.from("tasks")
    .update({task_date:formatDate(current.getFullYear(),current.getMonth(),day)})
    .eq("id",dragTask.id);
  dragTask=null;
}

/* ================= UI ================= */
function openModal(d){selectedDay=d;modal.style.display="flex"}
function closeModal(e){if(!e||e.target===modal)modal.style.display="none"}
function changeMonth(n){current.setMonth(current.getMonth()+n);render()}
function toggleStats(){
  stats.style.display=stats.style.display==="block"?"none":"block";
}

/* ================= INIT ================= */
Object.keys(PEOPLE).forEach(p=>{
  taskPerson.innerHTML+=`<option>${p}</option>`;
  filterPerson.innerHTML+=`<option>${p}</option>`;
});
TYPES.forEach(t=>taskType.innerHTML+=`<option>${t}</option>`);
filterPerson.onchange=e=>{
  activePersonFilter=e.target.value;
  renderCalendarOnly();
};

supabaseClient.channel("tasks-rt")
  .on("postgres_changes",{event:"*",schema:"public",table:"tasks"},render)
  .subscribe();

render();
</script>
</body>
</html>
