<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Monthly Task Calendar</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0f1115;color:#eaeaea}
header{padding:10px 16px;display:flex;justify-content:space-between}
header button{background:#1f2228;color:#fff;border:none;padding:6px 10px}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#14161b}
.weekdays div{text-align:center;padding:6px 0;font-size:12px;opacity:.7}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);height:calc(100vh - 120px)}
.day{border:1px solid #24262b;padding:6px;font-size:12px}
.day-number{opacity:.6;margin-bottom:4px}
.task{padding:6px;border-radius:6px;margin-bottom:4px;color:#000;cursor:pointer}
.task.done{background:#c8e6c9!important}
.task-type{font-size:10px;opacity:.8}
.delete{float:right;cursor:pointer}
.add{opacity:.5;font-size:11px;cursor:pointer}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-box{background:#1b1d22;padding:16px;border-radius:10px;width:260px}
.modal-box input,.modal-box select{width:100%;margin-bottom:8px;padding:6px}
.stats-toggle{position:fixed;bottom:10px;right:10px;background:#1f2228;padding:6px 10px;cursor:pointer}
.stats{position:fixed;bottom:50px;right:10px;background:#1b1d22;padding:12px;border-radius:8px;display:none;font-size:12px;width:220px}
</style>
</head>

<body>

<header>
<button onclick="changeMonth(-1)">‚Üê</button>
<div id="title"></div>
<button onclick="changeMonth(1)">‚Üí</button>
</header>

<div class="weekdays">
<div>Mon</div><div>Tue</div><div>Wed</div>
<div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div class="calendar" id="calendar"></div>

<div class="modal" id="modal" onclick="if(event.target.id==='modal')modal.style.display='none'">
  <div class="modal-box">
    <input id="taskText" placeholder="Task name">
    <select id="taskPerson"></select>
    <select id="taskType"></select>
    <button onclick="saveTask()">Add Task</button>
  </div>
</div>

<div class="stats-toggle" onclick="stats.style.display=stats.style.display==='block'?'none':'block'">üìä Stats</div>
<div class="stats" id="stats"></div>

<script>
/* ===== SUPABASE (CH·ªà 1 L·∫¶N) ===== */
const supabase = window.supabase.createClient(
  "https://letbykkygmmdxbmnemam.supabase.co",
  "sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);

/* ===== CONFIG ===== */
const PEOPLE={
  Tony:"#ff8a80",Allen:"#90caf9",Davis:"#b39ddb",Alex:"#ffe082",
  Lucas:"#b0bec5",Hayden:"#f48fb1",Leo:"#ce93d8",Dante:"#a5d6a7"
};
const TYPES=["Design + QR","Design","Menu + QR","Menu","QR"];

let current=new Date();
let selectedDay=null;
let cache={};

/* ===== LOAD ===== */
async function load(){
  const {data}=await supabase
    .from("tasks")
    .select("*")
    .eq("year",current.getFullYear())
    .eq("month",current.getMonth());

  cache={};
  data.forEach(t=>{
    cache[t.day]??=[];
    cache[t.day].push(t);
  });
}

/* ===== RENDER ===== */
async function render(){
  await load();
  title.textContent=`Th√°ng ${current.getMonth()+1}/${current.getFullYear()}`;
  calendar.innerHTML="";

  const days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
  const offset=(new Date(current.getFullYear(),current.getMonth(),1).getDay()+6)%7;
  for(let i=0;i<offset;i++)calendar.appendChild(document.createElement("div"));

  for(let d=1;d<=days;d++){
    const box=document.createElement("div");
    box.className="day";
    box.innerHTML=`<div class="day-number">${d}</div>`;

    (cache[d]||[]).forEach(t=>{
      const el=document.createElement("div");
      el.className="task"+(t.done?" done":"");
      el.style.background=PEOPLE[t.person];
      el.innerHTML=`<span class="delete" onclick="event.stopPropagation();removeTask(${t.id})">‚úñ</span>
      <b>${t.text}</b><div class="task-type">${t.person} ‚Ä¢ ${t.type}</div>`;
      el.onclick=()=>toggleDone(t);
      box.appendChild(el);
    });

    const add=document.createElement("div");
    add.className="add";
    add.textContent="+ Add task";
    add.onclick=()=>{selectedDay=d;modal.style.display="flex"};
    box.appendChild(add);

    calendar.appendChild(box);
  }
  renderStats();
}

/* ===== ACTIONS ===== */
async function saveTask(){
  if(!taskText.value)return;
  await supabase.from("tasks").insert({
    year:current.getFullYear(),
    month:current.getMonth(),
    day:selectedDay,
    text:taskText.value,
    person:taskPerson.value,
    type:taskType.value
  });
  taskText.value="";
  modal.style.display="none";
}
async function toggleDone(t){
  await supabase.from("tasks").update({done:!t.done}).eq("id",t.id);
}
async function removeTask(id){
  await supabase.from("tasks").delete().eq("id",id);
}

/* ===== STATS ===== */
function renderStats(){
  let all=[],done=0;
  Object.values(cache).forEach(a=>a.forEach(t=>{all.push(t);if(t.done)done++;}));
  stats.innerHTML=`Total:${all.length}<br>Done:${done}<br>Pending:${all.length-done}`;
}

/* ===== MONTH ===== */
function changeMonth(n){current.setMonth(current.getMonth()+n);render();}

/* ===== REALTIME ===== */
supabase.channel("tasks-rt")
  .on("postgres_changes",{event:"*",schema:"public",table:"tasks"},()=>render())
  .subscribe();

/* ===== INIT ===== */
Object.keys(PEOPLE).forEach(p=>taskPerson.innerHTML+=`<option>${p}</option>`);
TYPES.forEach(t=>taskType.innerHTML+=`<option>${t}</option>`);
render();
</script>
</body>
</html>
