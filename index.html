<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --border:#ddd;
  --blue:#2563eb;
  --green:#166534;
}
body{
  font-family:system-ui;
  margin:0;
  background:#f5f7fb;
}
header{
  display:flex;
  justify-content:space-between;
  padding:12px;
  background:#fff;
  border-bottom:1px solid var(--border);
}
select,button,input{
  padding:6px 10px;
}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
  padding:12px;
}
.day{
  background:#fff;
  min-height:120px;
  border:1px solid var(--border);
  padding:6px;
}
.day h4{
  margin:0 0 4px;
  font-size:13px;
}
.task{
  background:#eef2ff;
  padding:6px;
  margin-bottom:4px;
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
  position:relative;
}
.task.done{
  background:#16a34a;
  color:#fff;
}
.task.done::after{
  content:"completed";
  position:absolute;
  top:4px;
  right:6px;
  font-size:9px;
  opacity:.85;
}
.task:hover .copy{
  opacity:1;
}
.copy{
  position:absolute;
  bottom:4px;
  right:6px;
  font-size:12px;
  cursor:pointer;
  opacity:0;
}
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#111;
  color:#fff;
  padding:10px 16px;
  border-radius:8px;
  opacity:0;
  transform:translateY(10px);
  transition:.3s;
}
.toast.show{
  opacity:1;
  transform:none;
}
.readonly .add,
.readonly .task{
  pointer-events:none;
}
.readonly .add{
  display:none;
}
</style>
</head>

<body>

<header>
  <div>
    <button class="add" onclick="openModal()">ï¼‹ Add task</button>
  </div>
  <select id="filterPerson" onchange="renderCalendar()">
    <option value="">All</option>
    <option>Alex</option>
    <option>Anna</option>
    <option>John</option>
  </select>
</header>

<div class="calendar" id="calendar"></div>

<div class="toast" id="toast">Copied!</div>

<!-- MODAL -->
<div id="modal" style="display:none;position:fixed;inset:0;background:#0005">
  <div style="background:#fff;width:300px;margin:100px auto;padding:16px">
    <h3>Add Task</h3>
    <input id="taskText" placeholder="Task name" style="width:100%"><br><br>
    <select id="taskPerson" style="width:100%">
      <option>Alex</option>
      <option>Anna</option>
      <option>John</option>
    </select><br><br>
    <button onclick="saveTask()">Save</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const SUPABASE_URL = "https://letbykkygmmdxbmnemam.supabase.co";
const SUPABASE_KEY = "YOUR_ANON_KEY";
const OWNER_KEY = "my-secret-2026";

/* ========== INIT ========== */
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const IS_OWNER = localStorage.getItem("owner_key") === OWNER_KEY;
if(!IS_OWNER) document.body.classList.add("readonly");

/* ========== STATE ========== */
let current = new Date();
current.setDate(1);
let cache = {};
let selectedDay = null;

/* ========== UTIL ========== */
function formatDate(y,m,d){
  return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
}
function toast(){
  const t=document.getElementById("toast");
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}

/* ========== LOAD ========== */
async function loadTasks(){
  const start = formatDate(current.getFullYear(),current.getMonth(),1);
  const end   = formatDate(current.getFullYear(),current.getMonth()+1,0);

  const {data} = await supabaseClient
    .from("tasks")
    .select("*")
    .gte("task_date",start)
    .lte("task_date",end);

  cache = {};
  data.forEach(t=>{
    const d = Number(t.task_date.split("-")[2]);
    (cache[d]??=[]).push(t);
  });
  renderCalendar();
}

/* ========== RENDER ========== */
function renderCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
  const filter=document.getElementById("filterPerson").value;

  for(let d=1;d<=days;d++){
    const box=document.createElement("div");
    box.className="day";
    box.innerHTML=`<h4>${d}</h4>`;

    (cache[d]||[])
      .filter(t=>!filter||t.person===filter)
      .forEach(t=>{
        const div=document.createElement("div");
        div.className="task"+(t.done?" done":"");
        div.textContent=t.text;

        const c=document.createElement("span");
        c.className="copy";
        c.textContent="ðŸ“‹";
        c.onclick=e=>{
          e.stopPropagation();
          navigator.clipboard.writeText(t.text);
          toast();
        };
        div.appendChild(c);

        div.onclick=()=>toggleDone(t);
        box.appendChild(div);
      });

    box.onclick=()=>selectedDay=d;
    cal.appendChild(box);
  }
}

/* ========== ACTIONS ========== */
function openModal(){
  document.getElementById("modal").style.display="block";
}
function closeModal(){
  document.getElementById("modal").style.display="none";
}
async function saveTask(){
  if(!IS_OWNER) return;
  const text=taskText.value.trim();
  if(!text||!selectedDay)return;

  const task={
    task_date:formatDate(current.getFullYear(),current.getMonth(),selectedDay),
    text,
    person:taskPerson.value,
    done:false
  };

  (cache[selectedDay]??=[]).push(task);
  renderCalendar();
  closeModal();

  await supabaseClient.from("tasks").insert(task);
}
async function toggleDone(t){
  if(!IS_OWNER)return;
  t.done=!t.done;
  renderCalendar();
  await supabaseClient.from("tasks").update({done:t.done}).eq("id",t.id);
}

/* ========== START ========== */
loadTasks();
</script>

</body>
</html>
