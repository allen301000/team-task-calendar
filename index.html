<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Team Task Calendar</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:system-ui;background:#0f1115;color:#eaeaea}
header{padding:10px 16px;display:flex;gap:8px;justify-content:space-between;align-items:center}
header button,header select{background:#1f2228;color:#fff;border:none;padding:6px 10px}

.weekdays{display:grid;grid-template-columns:repeat(7,1fr);background:#14161b;border-bottom:1px solid #24262b}
.weekdays div{text-align:center;padding:6px 0;font-size:12px;opacity:.7}

.calendar{display:grid;grid-template-columns:repeat(7,1fr);height:calc(100vh - 120px)}
.day{border:1px solid #24262b;padding:6px;font-size:12px}
.day-number{opacity:.6;margin-bottom:4px}

.task{position:relative;padding:6px;border-radius:6px;margin-bottom:4px;cursor:grab;color:#000}
.task.completed{background:#2e7d32!important;color:#fff}
.task-type{font-size:10px;opacity:.85}

.completed-badge{
  position:absolute;
  top:4px;
  right:6px;
  font-size:9px;
  padding:2px 4px;
  border-radius:4px;
  background:rgba(0,0,0,.35);
  color:#b9f6ca;
}

.delete{
  position:absolute;
  bottom:4px;
  right:6px;
  font-size:11px;
  cursor:pointer;
  opacity:0;
}
.task:hover .delete{opacity:1}

.add{opacity:.5;cursor:pointer;font-size:11px}
.add:hover{opacity:1}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal-box{background:#1b1d22;padding:16px;border-radius:10px;width:260px}
.modal-box input,.modal-box select{width:100%;margin-bottom:8px;padding:6px}
.modal-box button{width:100%}

.stats-toggle{position:fixed;bottom:10px;right:10px;background:#1f2228;padding:6px 10px;cursor:pointer}
.stats{position:fixed;bottom:50px;right:10px;background:#1b1d22;padding:12px;border-radius:8px;display:none;font-size:12px;width:220px}
.stats h4{margin:6px 0 4px;font-size:12px;border-bottom:1px solid #333}
</style>
</head>

<body>

<header>
  <button onclick="changeMonth(-1)">‚Üê</button>
  <div id="title"></div>
  <button onclick="changeMonth(1)">‚Üí</button>

  <select id="filterPerson">
    <option value="">All</option>
  </select>
</header>

<div class="weekdays">
  <div>Mon</div><div>Tue</div><div>Wed</div>
  <div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
</div>

<div class="calendar" id="calendar"></div>

<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-box">
    <input id="taskText" placeholder="Task name">
    <select id="taskPerson"></select>
    <select id="taskType"></select>
    <button onclick="saveTask()">Add Task</button>
  </div>
</div>

<div class="stats-toggle" onclick="toggleStats()">üìä Stats</div>
<div class="stats" id="stats"></div>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  "https://letbykkygmmdxbmnemam.supabase.co",
  "sb_publishable_AIRw5d-xegyZkpX39_4MLQ_yK1tZMZo"
);

/* ================= CONFIG ================= */
const PEOPLE={
  Tony:"#ff8a80",Allen:"#90caf9",Davis:"#b39ddb",Alex:"#ffe082",
  Lucas:"#b0bec5",Hayden:"#f48fb1",Leo:"#ce93d8",Dante:"#a5d6a7"
};
const TYPES=["Design + QR","Design","Menu + QR","Menu","QR"];

/* ================= STATE ================= */
let current=new Date();
let selectedDay=null;
let dragTask=null;
let cache={};
let filterPerson="";

/* ================= DATE ================= */
const fmt=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;

/* ================= LOAD ================= */
async function load(){
  const y=current.getFullYear(),m=current.getMonth();
  const start=fmt(new Date(y,m,1));
  const end=fmt(new Date(y,m+1,0));

  const {data}=await supabaseClient
    .from("tasks")
    .select("*")
    .gte("task_date",start)
    .lte("task_date",end);

  cache={};
  (data||[]).forEach(t=>{
    const d=Number(t.task_date.slice(8,10));
    (cache[d]??=[]).push(t);
  });
}

/* ================= RENDER ================= */
async function render(){
  await load();
  calendar.innerHTML="";
  title.textContent=`Th√°ng ${current.getMonth()+1} / ${current.getFullYear()}`;

  const days=new Date(current.getFullYear(),current.getMonth()+1,0).getDate();
  const offset=(new Date(current.getFullYear(),current.getMonth(),1).getDay()+6)%7;

  for(let i=0;i<offset;i++) calendar.appendChild(document.createElement("div"));

  for(let d=1;d<=days;d++){
    const el=document.createElement("div");
    el.className="day";
    el.innerHTML=`<div class="day-number">${d}</div>`;
    el.ondragover=e=>e.preventDefault();
    el.ondrop=()=>dropTask(d);

    (cache[d]||[])
      .filter(t=>!filterPerson||t.person===filterPerson)
      .forEach(t=>{
        const task=document.createElement("div");
        task.className="task"+(t.done?" completed":"");
        task.style.background=t.done?"#2e7d32":PEOPLE[t.person];
        task.draggable=true;
        task.ondragstart=()=>dragTask=t;
        task.onclick=()=>toggleDone(t);

        task.innerHTML=`
          <strong>${t.text}</strong>
          <div class="task-type">${t.person} ‚Ä¢ ${t.type}</div>
          ${t.done?`<div class="completed-badge">COMPLETED</div>`:""}
        `;

        const del=document.createElement("span");
        del.className="delete";
        del.textContent="‚úñ";
        del.onclick=e=>{e.stopPropagation();removeTask(t.id);};

        task.appendChild(del);
        el.appendChild(task);
      });

    const add=document.createElement("div");
    add.className="add";
    add.textContent="+ Add task";
    add.onclick=()=>openModal(d);
    el.appendChild(add);

    calendar.appendChild(el);
  }

  renderStats();
}

/* ================= ACTIONS ================= */
async function saveTask(){
  if(!selectedDay||!taskText.value.trim())return;

  const row={
    task_date:fmt(new Date(current.getFullYear(),current.getMonth(),selectedDay)),
    text:taskText.value,
    person:taskPerson.value,
    type:taskType.value,
    done:false
  };

  (cache[selectedDay]??=[]).push({...row});
  render();
  closeModal();

  await supabaseClient.from("tasks").insert(row);
}

async function toggleDone(t){
  t.done=!t.done;
  render();
  await supabaseClient.from("tasks").update({done:t.done}).eq("id",t.id);
}

async function removeTask(id){
  Object.values(cache).forEach(a=>{
    const i=a.findIndex(t=>t.id===id);
    if(i>-1)a.splice(i,1);
  });
  render();
  await supabaseClient.from("tasks").delete().eq("id",id);
}

async function dropTask(day){
  if(!dragTask)return;
  dragTask.task_date=fmt(new Date(current.getFullYear(),current.getMonth(),day));
  render();
  await supabaseClient.from("tasks")
    .update({task_date:dragTask.task_date}).eq("id",dragTask.id);
  dragTask=null;
}

/* ================= UI ================= */
function openModal(d){selectedDay=d;modal.style.display="flex";}
function closeModal(e){if(!e||e.target===modal)modal.style.display="none";}
function changeMonth(n){current.setMonth(current.getMonth()+n);render();}
function toggleStats(){stats.style.display=stats.style.display==="block"?"none":"block";}

/* ================= STATS ================= */
function renderStats(){
  let all=[],done=0;
  Object.values(cache).forEach(a=>a.forEach(t=>{all.push(t);if(t.done)done++;}));
  stats.innerHTML=`
    <h4>T·ªïng quan</h4>
    T·ªïng: ${all.length}<br>Done: ${done}<br>Pending: ${all.length-done}
  `;
}

/* ================= INIT ================= */
Object.keys(PEOPLE).forEach(p=>{
  taskPerson.innerHTML+=`<option>${p}</option>`;
  filterPerson.innerHTML+=`<option value="${p}">${p}</option>`;
});
filterPerson.onchange=e=>{filterPerson=e.target.value;render();};
TYPES.forEach(t=>taskType.innerHTML+=`<option>${t}</option>`);
render();
</script>

</body>
</html>
